<?php
////////////////////////////////////////////////////////////////////////////////
//
//  Copyright © 2008 Hewlett-Packard Development Company, L.P. 
//
//  This work is distributed under the W3C¬ Software License 
//  [1] in the hope that it will be useful, but WITHOUT ANY 
//  WARRANTY; without even the implied warranty of 
//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. 
//
//  [1] http://www.w3.org/Consortium/Legal/2002/copyright-software-20021231 
//
//////////////////////////////////////////////////////////////////////////////// 

//////////////////////////////////////////////////////////////////////////////// 
//
//  class.test_results.phi
//
//  Provides results reporting functionality as a proxy to that provided to the
//  Mobile Test Harness [1].
//
//  Currently, this file represents a place holder for a work in progress.
//  Additional requested functionality, including various results concolidations
//  and cross tabulations, are in active development.
//
// [1] http://dev.w3.org/cvsweb/2007/mobile-test-harness/
//
//////////////////////////////////////////////////////////////////////////////// 

require_once("./lib_test_harness/class.db_connection.phi");

////////////////////////////////////////////////////////////////////////////////
//
//  class test_results
//
//  test_results is a concrete db_connection taylored for storing the 
//  testing results tables.
//
////////////////////////////////////////////////////////////////////////////////
class test_results extends db_connection
{
  ////////////////////////////////////////////////////////////////////////////
  //
  //  Instance variables.
  //
  ////////////////////////////////////////////////////////////////////////////
  var $m_engines;
  var $m_data;
  var $m_test_suite;
  
  var $m_testcase_count;
  var $m_testcase_pass_count;
  var $m_testcase_may_count;
  var $m_testcase_may_pass_count;
  var $m_testcase_invalid_count;
  var $m_testcase_needed_count;

  ////////////////////////////////////////////////////////////////////////////
  //
  //  Constructor
  //
  ////////////////////////////////////////////////////////////////////////////
  function test_results
    ( $test_suite
    , $test_select
    , $select_type
    , $engine
    , $engine_version
    , $platform
    , $grouping
    , $modified
    , $order
    )
  {
    parent::db_connection();
    
    $this->m_test_suite = $test_suite;
/*    
    $sql  = "SELECT testcase as Test, useragent as UserAgent, ";
    $sql .= "SUM(result='pass') as Pass, SUM(result='fail') as Fail, ";
    $sql .= "SUM(result='uncertain') as Uncertain, ";
    $sql .= "COUNT(*) as count ";
    $sql .= "FROM results GROUP BY testcase, useragent ";
*/

    $sql = "SELECT DISTINCT engine FROM useragents WHERE engine!='' ORDER BY engine";
    $r = $this->query($sql);
    if (! $r->is_false()) {
      $db_engines = $r->fetch_table();
      foreach ($db_engines as $db_engine) {
        $this->m_engines[] = $db_engine['engine'];
      }
    }

    $sql  = "SELECT testcase, engine, flags, SUM(pass) as pass, ";
    $sql .= "SUM(fail) as fail, SUM(uncertain) as uncertain, ";
    $sql .= "SUM(invalid) as invalid, SUM(na) as na, ";
    $sql .= "COUNT(pass + fail + uncertain + invalid + na) as count FROM (";
    
    $sql .= "SELECT testcases.title, testcases.testsuite, ";
    $sql .= "testcases.testgroup, testcases.testcase, results.useragent_id, ";
    $sql .= "results.modified, useragents.engine, testcases.active, ";
    $sql .= "testcases.flags, result='pass' AS pass, ";
    $sql .= "result='fail' AS fail, result='uncertain' AS uncertain, ";
    $sql .= "result='invalid' AS invalid, result='na' AS na ";
    $sql .= "FROM testcases LEFT JOIN (results, useragents) ";
    $sql .= "ON (testcases.id=results.testcase_id AND results.useragent_id=useragents.id)) as t ";
    
    $sql .= "WHERE t.testsuite LIKE '{$test_suite}' ";
    $sql .= "AND t.active='1' ";
    
    if($test_select) {
      if($select_type == 1) {
        $sql .= "AND t.testgroup = '{$test_select}' ";
      } elseif($select_type==2) {
        $sql .= "AND t.testcase = '{$test_select}' ";
      }
    }
    
    if($modified) {
      $sql .= "AND t.modified <= '{$modified}' ";
    }  
    
    if($engine) {
      $sql .= "AND engine='{$engine}' ";
      if($engine_version) {
        $sql .= "AND engine_version = '{$engine_version}' ";
      }
      if($platform) {
        $sql .= "AND platform = '{$platform}' ";
      }
    }
    if($grouping == 's') {
      $sql .= "GROUP BY testsuite, testcase, ";
    } elseif($grouping == 'g') {
      $sql .= "GROUP BY testgroup, testcase, ";
    } else {
      $sql .= "GROUP BY testcase, ";
    }
    $sql .= "engine "; 
    if ($engine_version) {
      $sql .= ", engine_version ";
    }

//print $sql;
    $r = $this->query($sql);

    if($r->is_false()) {
      $msg = 'Unable to obtain results.';
      trigger_error($msg, E_USER_ERROR);
    }

    $this->m_data = $r->fetch_table();
  }
  
  function _generate_row($testcase, $engine_results, $may)
  {
    $row = "<td><a href='details?s={$this->m_test_suite}&c={$testcase}'>{$testcase}</a></td>";

    $test_invalid = FALSE;
    $pass_count = 0;
    foreach ($this->m_engines as $engine) {
      if (array_key_exists($engine, $engine_results['count'])) {
        $pass      = $engine_results['pass'][$engine];
        $fail      = $engine_results['fail'][$engine];
        $uncertain = $engine_results['uncertain'][$engine];
        $invalid   = $engine_results['invalid'][$engine];
        $na        = $engine_results['na'][$engine];
        $class = '';
        if (0 < $pass) {
          $pass_count++;
          $class .= 'pass ';
        }
        if (0 < $fail) {
          $class .= 'fail ';
        }
        if (0 < $uncertain) {
          $class .= 'uncertain ';
        }
        if (0 < $invalid) {
          $class .= 'invalid ';
          $test_invalid = TRUE;
        }
        if (0 < $na) {
          $class .= 'na ';
        }
        $row .= "<td class='{$class}'>";
        $row .= "<a href='details?s={$this->m_test_suite}&c={$testcase}&e={$engine}'>";
        $row .= ((0 < $pass) ? $pass : '.') . '&nbsp;/&nbsp;';
        $row .= ((0 < $fail) ? $fail : '.') . '&nbsp;/&nbsp;';
        $row .= ((0 < $uncertain) ? $uncertain : '.');
        $row .= "</a>";
        $row .= "</td>";
      }
      else {
        $row .= "<td>&nbsp;</td>";
      }
    }
    $class = '';
    if ($test_invalid) {
      $class = 'invalid ';
      $this->m_testcase_invalid_count++;
    }
    if ($may) {
      $class .= 'may ';
      $this->m_testcase_may_count++;
    }
    else {
      $this->m_testcase_count++;
    }
    if (1 < $pass_count) {
      $class .= 'pass';
      if ($may) {
        $this->m_testcase_may_pass_count++;
      } else {
        $this->m_testcase_pass_count++;
      }
    }
    else {
      if ((! $test_invalid) && (! $may)) {
        $this->m_testcase_needed_count++;
      }
    }
    return "  <tr class='{$class}'>{$row}</tr>\n";
  }

  ////////////////////////////////////////////////////////////////////////////
  //
  //  write
  //
  //  Write HTML for a table displaying the results data.
  //
  ////////////////////////////////////////////////////////////////////////////
  function write($indent)
  {

    if(!($this->m_data)) {
      echo $indent . "<p>No results entered matching this query.</p>\n";
    } else {

      echo $indent . "<table>\n";
      echo $indent . "  <tr>\n";
      echo $indent . "    <th>Testcase</th>\n";
      foreach ($this->m_engines as $engine) {
        echo $indent . "    <th>{$engine}</th>\n";
      }
      echo $indent . "  </tr>\n";
      
      $this->m_testcase_count = 0;
      $this->m_testcase_pass_count = 0;
      $this->m_testcase_may_count = 0;
      $this->m_testcase_may_pass_count = 0;
      $this->m_testcase_invalid_count = 0;

      $last_testcase = '';
      $may = FALSE;
      foreach ($this->m_data as $result) {
        $testcase = $result['testcase'];
        $flags    = $result['flags'];
        $may = (FALSE !== stripos($flags, 'may')) || (FALSE !== stripos($flags, 'should'));
        if ($testcase != $last_testcase) {
          if ($last_testcase) {
            echo $indent . $this->_generate_row($last_testcase, $engine_results, $may);
          }
          unset ($engine_results);
        }
        $engine = $result['engine'];
        $engine_results['pass'][$engine]      = $result['pass'];
        $engine_results['fail'][$engine]      = $result['fail'];
        $engine_results['uncertain'][$engine] = $result['uncertain'];
        $engine_results['invalid'][$engine]   = $result['invalid'];
        $engine_results['na'][$engine]        = $result['na'];
        $engine_results['count'][$engine]     = $result['count'];
        
        $last_testcase = $testcase;
      }
      
      echo $indent . $this->_generate_row($testcase, $engine_results, $may);
      
      echo $indent . "</table>\n";
      echo $indent . "<p>{$this->m_testcase_pass_count} of {$this->m_testcase_count} required tests meet exit criteria.</p>\n";
      echo $indent . "<p>{$this->m_testcase_may_pass_count} of {$this->m_testcase_may_count} optional tests meet exit criteria.</p>\n";
      echo $indent . "<p>{$this->m_testcase_invalid_count} tests reported as invalid.</p>\n";
      echo $indent . "<p>{$this->m_testcase_needed_count} required tests are considered valid and do not meet exit criteria.</p>\n";

/*
      echo $indent . '<table>' . "\n";
      echo $indent . '  <tr>' ."\n";
      foreach($this->m_data[0] as $key=>$value) {
        echo $indent . '    <th>' ."\n";
        echo $indent . '      ' . $key;
        echo $indent . '    </th>' ."\n";
      }
      echo $indent . '  </tr>' ."\n";

      foreach($this->m_data as $result) {
      
        echo $indent . '  <tr>' ."\n";
        foreach($result as $value) {
          echo $indent . '    <td>' ."\n";
          echo $indent . '      ' . $value;
          echo $indent . '    </td>' ."\n";
        }
        echo $indent . '  </tr>' ."\n";
      }
      echo $indent . '</table>' . "\n";
 */
    }
  }
}

?>