<?php
////////////////////////////////////////////////////////////////////////////////
//
//  Copyright © 2010 Hewlett-Packard Development Company, L.P. 
//
//  This work is distributed under the W3C¬ Software License 
//  [1] in the hope that it will be useful, but WITHOUT ANY 
//  WARRANTY; without even the implied warranty of 
//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. 
//
//  [1] http://www.w3.org/Consortium/Legal/2002/copyright-software-20021231 
//
//////////////////////////////////////////////////////////////////////////////// 

//////////////////////////////////////////////////////////////////////////////// 
//
//  class.SpiderTrap.phi
//
//  Provides functionality for detecting and blocking misbehaving web crawlers
//
//
//////////////////////////////////////////////////////////////////////////////// 

require_once("class.DBConnection.phi");
  
define('SPIDER_TRAP_URL', 'report');
define('SPIDER_TRAP_IMAGE', 'images/link.gif');


////////////////////////////////////////////////////////////////////////////////
//
//  class SpiderTrap
//
//  
//
////////////////////////////////////////////////////////////////////////////////
class SpiderTrap
{
  ////////////////////////////////////////////////////////////////////////////
  //
  //  Instance variables.
  //
  ////////////////////////////////////////////////////////////////////////////
  var $mDB;
  
  var $mSequence;
  var $mPageQuery;
  var $mPageURI;

  
  ////////////////////////////////////////////////////////////////////////////
  //
  //  Constructor
  //
  ////////////////////////////////////////////////////////////////////////////
  function __construct()
  {
    $this->mSequence = 0;
    $this->mPageQuery = $_SERVER['QUERY_STRING'];
    $this->mPageURI = $_SERVER['REQUEST_URI'];
  }
  

  function getLink()
  {
    $largeNumber = mt_rand(1000000, 9999999999);
    if ($this->mPageQuery) {
      parse_str($this->mPageQuery, $query);
      $query['seq'] = ++$this->mSequence;
      $query['uid'] = $largeNumber;
      $queryStr = http_build_query($query, 'var_');
    }
    else {
      $queryStr  = 'seq=' . ++$this->mSequence;
      $queryStr .= "&uid={$largeNumber}";
    }
    $link = "<a href='" . SPIDER_TRAP_URL . "?{$queryStr}' class='report'>{$this->mSequence}-{$largeNumber}</a>";
    return $link;
  }
  
  ////////////////////////////////////////////////////////////////////////////
  //
  //  generate link
  //
  //  Write HTML for a link to the spider trap
  //
  ////////////////////////////////////////////////////////////////////////////
  function generateLink($indent = '')
  {
    $link = $this->getLink();
    echo $indent . $link . "\n";
  }
  
  ////////////////////////////////////////////////////////////////////////////
  //
  //  _getDB
  //
  //  Bring DBConnection online lazily
  //
  ////////////////////////////////////////////////////////////////////////////
  protected function _getDB()
  {
    if (! isset($this->mDB)) {
      $this->mDB = new DBConnection();
    }
    return $this->mDB;
  }
  
  protected function _getClientIP()
  {
    if (! empty($_SERVER['REMOTE_ADDR'])) {
      $ip = $_SERVER['REMOTE_ADDR'];
    }
    elseif (! empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {
      $ip = $_SERVER['HTTP_X_FORWARDED_FOR'];
    }
    else {
      $ip = $_SERVER['HTTP_CLIENT_IP'];
    }
    return $ip;
  }
  

  
  ////////////////////////////////////////////////////////////////////////////
  //
  //  recordVisit
  //
  //  Capture data about a visit to the spider trap
  //
  ////////////////////////////////////////////////////////////////////////////
  function recordVisit()
  {
    $ipAddress = $this->_getClientIP();
    $userAgent = $_SERVER['HTTP_USER_AGENT'];

    $sql  = "INSERT INTO `spidertrap` (`ip_address`, `user_agent`, `last_uri`, `visit_count`, `first_visit`) ";
    $sql .= "VALUES ('{$ipAddress}', '{$userAgent}', '{$this->mPageURI}', '1', NOW()) ";
    $sql .= "ON DUPLICATE KEY UPDATE `user_agent` = '{$userAgent}', `last_uri` = '{$this->mPageURI}', `visit_count` = visit_count + 1";
    
    $db = $this->_getDB();
    $db->query($sql);
  }
  
}

?>